<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwagPlayer</title>
    <meta name="description" content="Музыкальная платформа для исполнителей">
    
    <link rel="icon" type="image/x-icon" href="https://api.dreampartners.online/icons/swagaplayerobot/favicon.ico">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/app.css">
    
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #121212;
            --card-border: transparent;
            --accent: #fa2d48;
            --text-muted: #b3b3b3;
        }
        
        body {
            background-color: var(--bg-color);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .bg-noise {
            display: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 300px;
            min-height: 100vh;
            overflow-y: visible;
        }
        
        /* HEADER */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 10px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: white;
            text-transform: lowercase;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn-icon-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1a1a1a;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .btn-icon-small:active {
            transform: scale(0.95);
            background: #333;
        }
        
        /* Кнопка "Назад" */
        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            text-decoration: none;
            margin: 0;
            padding: 0;
        }
        
        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            height: 40px; /* Фиксированная высота для выравнивания */
        }
        
        .main-header .back-btn {
            align-self: center;
            flex-shrink: 0;
            height: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .main-header .logo {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .main-header .header-actions {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            height: 40px;
        }
        
        .main-header .btn-icon-small {
            height: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-2px);
        }
        
        .back-btn:active {
            transform: translateX(-2px) scale(0.95);
        }
        
        .main-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .main-header .logo {
            flex: 1;
        }
        
        /* SEARCH */
        .search-container {
            position: sticky;
            top: 10px;
            z-index: 100;
            margin-bottom: 30px;
        }
        
        .search-form {
            position: relative;
            width: 100%;
        }
        
        .search-form input {
            width: 100%;
            padding: 12px 45px;
            background: #1f1f1f;
            border: 1px solid transparent;
            border-radius: 50px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: background 0.2s;
        }
        
        .search-form input:focus {
            background: #2a2a2a;
            border-color: #333;
        }
        
        .search-form input::placeholder {
            color: #777;
        }
        
        .search-form ion-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #b3b3b3;
            font-size: 20px;
        }
        
        /* GRID & LIST */
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
            text-transform: none;
            letter-spacing: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .track-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 40px;
        }
        
        /* ALBUM CARD (Grid) */
        .card {
            background: #181818;
            border: none;
            border-radius: 8px;
            padding: 16px;
            transition: background 0.2s;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            background: #282828;
        }
        
        .card-cover {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 6px;
            object-fit: cover;
            margin-bottom: 16px;
            background: #333;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        .card-pinned {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #fa2d48;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            z-index: 2;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .card-subtitle {
            font-size: 14px;
            color: #b3b3b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-user {
            display: block; /* Показываем пользователя в карточке альбома */
        }
        
        /* TRACK ITEM (List) */
        .track-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-radius: 6px;
            text-decoration: none;
            color: inherit;
            transition: background 0.2s;
            gap: 16px;
        }
        
        .track-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .track-cover {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
            background: #333;
        }
        
        .track-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .track-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        
        .track-artist {
            font-size: 14px;
            color: #b3b3b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-play-track {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid #555;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-play-track:hover {
            border-color: white;
            transform: scale(1.05);
        }
        
        .track-pinned-icon {
            color: #fa2d48;
            font-size: 14px;
            margin-left: 6px;
            vertical-align: middle;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #777;
        }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }
        
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            padding: 8px 16px;
            border-radius: 30px;
            background: #2a2a2a;
            color: white;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .tab-btn.active {
            background: white;
            color: black;
        }
        
        /* MOBILE ADAPTATION */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .card {
                padding: 12px;
            }
            .card-title { font-size: 14px; }
            .card-subtitle { font-size: 12px; }
            
            .track-item {
                padding: 8px 0;
            }
        }
    </style>
</head>
<body>
    <div class="bg-noise"></div>
    
    <div class="container">
        <header class="main-header">
            <button class="back-btn" onclick="window.SPANavigation?.goBack() || window.history.back()" style="display:none;">
                <ion-icon name="arrow-back"></ion-icon>
            </button>
            <div class="logo">swagplayer</div>
            <div class="header-actions">
                <a href="/app" class="btn-icon-small" data-no-spa="true">
                    <ion-icon name="person"></ion-icon>
                </a>
            </div>
        </header>
        
        <div class="search-container">
            <form action="/" method="get" class="search-form">
                <ion-icon name="search"></ion-icon>
                <input type="text" name="q" placeholder="Что хотите послушать?" value="{{ search_query }}" autocomplete="off">
            </form>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="filterContent('all')">Все</div>
            <div class="tab-btn" onclick="filterContent('tracks')">Треки</div>
            <div class="tab-btn" onclick="filterContent('albums')">Альбомы</div>
        </div>

        <!-- Tracks (LIST VIEW) -->
        <div id="content-tracks">
                {% if tracks %}
            <div class="section-title">
                Треки
            </div>
            <div class="track-list">
                    {% for track in tracks %}
                <div class="track-item" onclick="playTrackFromList(this.dataset.trackIndex)" style="cursor: pointer;" data-track-index="{{ loop.index0 }}" data-track-id="{{ track.id }}">
                    <img src="/uploads/{{ track.cover_filename }}" alt="{{ track.title }}" class="track-cover" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display:none; width:48px; height:48px; border-radius:4px; background:#333; align-items:center; justify-content:center; flex-shrink:0;">
                        <ion-icon name="musical-notes" style="font-size:20px; color:#666;"></ion-icon>
                    </div>
                    <div class="track-info">
                        <div class="track-title">
                            {{ track.title }}
                            {% if track.is_pinned %}<ion-icon name="flame" class="track-pinned-icon"></ion-icon>{% endif %}
                        </div>
                        <div class="track-artist">
                            {% if track.nickname %}
                            <a href="/user/{{ track.nickname }}" onclick="event.stopPropagation();" style="color: rgba(255,255,255,0.6); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#fa2d48'" onmouseout="this.style.color='rgba(255,255,255,0.6)'">{{ track.artist }}</a>
                            {% else %}
                            {{ track.artist }}
                            {% endif %}
                        </div>
                        <div class="track-stats" style="display: flex; gap: 12px; margin-top: 4px; font-size: 12px; color: rgba(255,255,255,0.5);">
                            <span><ion-icon name="play" style="font-size: 12px; vertical-align: middle;"></ion-icon> {{ track.plays_count or 0 }}</span>
                            <span class="track-like-btn {{ 'liked' if track.is_liked else '' }}" data-track-id="{{ track.id }}" onclick="event.stopPropagation(); toggleTrackLike({{ track.id }})" style="cursor: pointer; display: flex; align-items: center; gap: 4px; transition: color 0.2s;" onmouseover="if(!this.classList.contains('liked')) this.style.color='#fa2d48'" onmouseout="if(!this.classList.contains('liked')) this.style.color='rgba(255,255,255,0.5)'">
                                <ion-icon name="{{ 'heart' if track.is_liked else 'heart-outline' }}" style="font-size: 12px; vertical-align: middle;"></ion-icon> 
                                <span class="track-likes-count">{{ track.likes_count or 0 }}</span>
                            </span>
                        </div>
                    </div>
                    <div class="track-actions">
                        <div class="btn-play-track" onclick="event.stopPropagation(); const idx = parseInt(this.closest('.track-item').dataset.trackIndex); playTrackFromList(idx);">
                            <ion-icon name="play" style="margin-left:2px;"></ion-icon>
                        </div>
                    </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

        <!-- Albums (GRID VIEW) -->
        <div id="content-albums">
            {% if albums %}
            <div class="section-title">
                    Альбомы
            </div>
                <div class="grid">
                    {% for album in albums %}
                <a href="/album/{{ album.slug or album.id }}" class="card" style="cursor: pointer; text-decoration: none; color: inherit; display: block;">
                    {% if album.is_pinned %}
                    <div class="card-pinned"><ion-icon name="flame"></ion-icon></div>
                    {% endif %}
                        {% if album.cover_filename %}
                    <img src="/uploads/{{ album.cover_filename }}" alt="{{ album.title }}" class="card-cover">
                    {% else %}
                    <div style="width:100%; aspect-ratio:1/1; border-radius:6px; background:linear-gradient(135deg, #333 0%, #1c1c1e 100%); display:flex; align-items:center; justify-content:center; margin-bottom:16px;">
                            <ion-icon name="albums" style="font-size:48px; color:#666;"></ion-icon>
                        </div>
                    {% endif %}
                    <div class="card-content">
                        <div class="card-title">{{ album.title }}</div>
                        <div class="card-subtitle">{{ album.description[:40] + '...' if album.description else 'Альбом' }}</div>
                        {% if album.display_name or album.nickname %}
                        <div class="card-user" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px;">
                            {% if album.avatar_url %}
                            <img src="{{ album.avatar_url }}" alt="" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                            {% endif %}
                            <span>{{ album.display_name or ('@' + album.nickname) if album.nickname else '' }}</span>
                        </div>
                            {% endif %}
                        <div class="card-stats" style="display: flex; gap: 12px; margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.5);">
                            <span><ion-icon name="play" style="font-size: 12px; vertical-align: middle;"></ion-icon> {{ album.plays_count or 0 }}</span>
                            <span class="album-like-btn {{ 'liked' if album.is_liked else '' }}" data-album-id="{{ album.id }}" onclick="event.stopPropagation(); toggleAlbumLike({{ album.id }})" style="cursor: pointer; display: flex; align-items: center; gap: 4px; transition: color 0.2s;" onmouseover="if(!this.classList.contains('liked')) this.style.color='#fa2d48'" onmouseout="if(!this.classList.contains('liked')) this.style.color='rgba(255,255,255,0.5)'">
                                <ion-icon name="{{ 'heart' if album.is_liked else 'heart-outline' }}" style="font-size: 12px; vertical-align: middle;"></ion-icon> 
                                <span class="album-likes-count">{{ album.likes_count or 0 }}</span>
                            </span>
                        </div>
                        </div>
                </a>
                    {% endfor %}
            </div>
            {% endif %}
                </div>

        {% if not tracks and not albums %}
        <div class="empty-state">
            <ion-icon name="search-outline" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></ion-icon>
            <p>Ничего не найдено</p>
        </div>
                {% endif %}
    </div>

    <!-- МОДУЛЬНЫЙ ПЛЕЕР (включает audio, mini-player и full-player) -->
    {% include 'player_component.html' %}

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Определяем Telegram WebView перед загрузкой player.js
        window.isTelegram = window.Telegram && window.Telegram.WebApp;
        window.tgWebApp = window.isTelegram ? window.Telegram.WebApp : null;
        window.SHARED_MODE = false;
        
        // Глобальные переменные для плеера
        // НЕ перезаписываем window.tracks здесь - это делается в playTrackFromList
        // window.pageTracks уже установлен ниже
        window.currentTrackIndex = 0;
        
        // Синхронизируем tracks с player.js после загрузки ТОЛЬКО если плеер пуст
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // Проверяем, есть ли уже треки в плеере (из localStorage)
                const audio = document.getElementById('audio-element');
                const isPlaying = audio && !audio.paused && audio.currentTime > 0;
                
                // Если плеер не играет, можем установить треки страницы
                if (!isPlaying && typeof window.setTracks === 'function' && window.pageTracks && window.pageTracks.length > 0) {
                    // Не устанавливаем автоматически - пусть пользователь сам выберет трек
                    console.log('Page has', window.pageTracks.length, 'tracks available');
                }
            }, 200);
        });
    </script>
    <script src="/static/js/navigation.js?v=2"></script>
    <script src="/static/js/player.js?v=19"></script>
    <script>
        // Tab filtering
        function filterContent(type) {
            const tracks = document.getElementById('content-tracks');
            const albums = document.getElementById('content-albums');
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'all') {
                if(tracks) tracks.style.display = 'block';
                if(albums) albums.style.display = 'block';
            } else if (type === 'tracks') {
                if(tracks) tracks.style.display = 'block';
                if(albums) albums.style.display = 'none';
            } else if (type === 'albums') {
                if(tracks) tracks.style.display = 'none';
                if(albums) albums.style.display = 'block';
            }
        }

        // Функции для лайков
        window.currentTrackLiked = false;
        window.currentTrackLikesCount = 0;
        
        async function toggleCurrentTrackLike() {
            if (!window.tracks || window.currentIndex === undefined || window.currentIndex < 0) {
                console.warn('No track playing');
                return;
            }
            const track = window.tracks[window.currentIndex];
            if (!track || !track.id) {
                console.warn('Track not found or no ID');
                return;
            }
            
            try {
                const res = await fetch(`/api/tracks/${track.id}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.success) {
                    // Обновляем глобальные переменные
                    if (typeof window.currentTrackLiked !== 'undefined') {
                        window.currentTrackLiked = data.liked;
                    }
                    if (typeof window.currentTrackLikesCount !== 'undefined') {
                        window.currentTrackLikesCount = data.likes_count;
                    }
                    // Обновляем трек в массиве
                    track.is_liked = data.liked;
                    track.likes_count = data.likes_count;
                    // Обновляем UI
                    if (typeof window.updateLikeUI === 'function') {
                        window.updateLikeUI();
                    }
                    // Обновляем на главной странице
                    const trackElement = document.querySelector(`.track-item[data-track-id="${track.id}"] .track-like-btn`);
                    if (trackElement) {
                        const likeIcon = trackElement.querySelector('ion-icon');
                        const likesCountSpan = trackElement.querySelector('.track-likes-count');
                        if (likeIcon) likeIcon.name = data.liked ? 'heart' : 'heart-outline';
                        if (likesCountSpan) likesCountSpan.textContent = data.likes_count;
                        if (data.liked) {
                            trackElement.classList.add('liked');
                        } else {
                            trackElement.classList.remove('liked');
                        }
                    }
                }
            } catch (e) {
                console.error('Error toggling like:', e);
            }
        }
        
        // Старая функция для совместимости
        async function toggleCurrentTrackLikeOld() {
            const tracksList = typeof window.tracks !== 'undefined' ? window.tracks : [];
            const currentIdx = typeof window.currentTrackIndex !== 'undefined' ? window.currentTrackIndex : (typeof currentIndex !== 'undefined' ? currentIndex : -1);
            if (currentIdx < 0 || !tracksList[currentIdx] || !tracksList[currentIdx].id) {
                alert('Сначала войдите в аккаунт для лайков');
                return;
            }
            
            const trackId = tracksList[currentIdx].id;
            try {
                const res = await fetch(`/api/tracks/${trackId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (res.ok) {
                    const data = await res.json();
                    window.currentTrackLiked = data.liked;
                    window.currentTrackLikesCount = data.likes_count || 0;
                    updateLikeButtons();
                } else if (res.status === 401) {
                    alert('Войдите в аккаунт для лайков');
                }
            } catch(e) {
                console.error('Error toggling like:', e);
            }
        }
        
        async function toggleTrackLike(trackId) {
            try {
                const res = await fetch(`/api/tracks/${trackId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        const btn = document.querySelector(`.track-like-btn[data-track-id="${trackId}"]`);
                        const countEl = btn ? btn.querySelector('.track-likes-count') : null;
                        const icon = btn ? btn.querySelector('ion-icon') : null;
                        if (btn && countEl && icon) {
                            countEl.textContent = data.likes_count || 0;
                            if (data.liked) {
                                btn.classList.add('liked');
                                btn.style.color = '#fa2d48';
                                icon.name = 'heart';
                            } else {
                                btn.classList.remove('liked');
                                btn.style.color = 'rgba(255,255,255,0.5)';
                                icon.name = 'heart-outline';
                            }
                        }
                        // Обновляем трек в массиве если он играет
                        if (window.tracks) {
                            const track = window.tracks.find(t => t.id === trackId);
                            if (track) {
                                track.is_liked = data.liked;
                                track.likes_count = data.likes_count;
                                // Обновляем UI в плеере если это текущий трек
                                if (window.currentIndex !== undefined && window.tracks[window.currentIndex] && window.tracks[window.currentIndex].id === trackId) {
                                    if (typeof window.updateLikeUI === 'function') {
                                        window.updateLikeUI();
                                    }
                                }
                            }
                        }
                    }
                } else if (res.status === 401) {
                    alert('Войдите в аккаунт для лайков');
                }
            } catch(e) {
                console.error('Error toggling track like:', e);
            }
        }
        
        async function toggleAlbumLike(albumId) {
            try {
                const res = await fetch(`/api/albums/${albumId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!res.ok) {
                    if (res.status === 401) {
                        alert('Войдите в аккаунт для лайков');
                    } else {
                        const errorData = await res.json().catch(() => ({}));
                        alert(errorData.error || 'Ошибка при постановке лайка');
                    }
                    return;
                }
                
                const data = await res.json();
                if (data.success) {
                    const btn = document.querySelector(`.album-like-btn[data-album-id="${albumId}"]`);
                    const countEl = btn ? btn.querySelector('.album-likes-count') : null;
                    const icon = btn ? btn.querySelector('ion-icon') : null;
                    if (btn && countEl && icon) {
                        countEl.textContent = data.likes_count || 0;
                        if (data.liked) {
                            btn.classList.add('liked');
                            btn.style.color = '#fa2d48';
                            icon.name = 'heart';
                            icon.setAttribute('fill', 'solid');
                        } else {
                            btn.classList.remove('liked');
                            btn.style.color = 'rgba(255,255,255,0.5)';
                            icon.name = 'heart-outline';
                            icon.removeAttribute('fill');
                        }
                    }
                } else {
                    alert(data.error || 'Ошибка при постановке лайка');
                }
            } catch(e) {
                console.error('Error toggling album like:', e);
                alert('Ошибка сети при постановке лайка');
            }
        }
        
        window.toggleTrackLike = toggleTrackLike;
        window.toggleAlbumLike = toggleAlbumLike;
        
        function updateLikeButtons() {
            const miniLikeBtn = document.getElementById('mini-like-btn');
            const miniLikeIcon = document.getElementById('mini-like-icon');
            const miniLikesCount = document.getElementById('mini-likes-count');
            const playerLikeBtn = document.getElementById('player-like-btn');
            const playerLikeIcon = document.getElementById('player-like-icon');
            const playerLikesCount = document.getElementById('player-likes-count');
            
            if (miniLikeBtn && miniLikeIcon) {
                if (window.currentTrackLiked) {
                    miniLikeBtn.classList.add('liked');
                    miniLikeIcon.name = 'heart';
                    miniLikeIcon.setAttribute('fill', 'solid');
                } else {
                    miniLikeBtn.classList.remove('liked');
                    miniLikeIcon.name = 'heart-outline';
                    miniLikeIcon.removeAttribute('fill');
                }
            }
            
            if (playerLikeBtn && playerLikeIcon && playerLikesCount) {
                if (window.currentTrackLiked) {
                    playerLikeBtn.style.background = 'rgba(250, 45, 72, 0.2)';
                    playerLikeIcon.name = 'heart';
                    playerLikeIcon.setAttribute('fill', 'solid');
                } else {
                    playerLikeBtn.style.background = 'rgba(255,255,255,0.1)';
                    playerLikeIcon.name = 'heart-outline';
                    playerLikeIcon.removeAttribute('fill');
                }
                playerLikesCount.textContent = window.currentTrackLikesCount || 0;
            }
        }
        
        function toggleMiniVolume() {
            const container = document.getElementById('mini-volume-container');
            const btn = document.querySelector('.mini-volume-btn');
            if (container && btn) {
                const isVisible = container.style.display !== 'none';
                container.style.display = isVisible ? 'none' : 'block';
                
                // Показываем регулятор только на устройствах с достаточным размером экрана
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const isSmallScreen = screenWidth < 360 || screenHeight < 500;
                
                if (isSmallScreen && !isVisible) {
                    // На маленьких экранах показываем предупреждение или используем системный регулятор
                    container.style.display = 'none';
                    // Можно показать toast или использовать системный регулятор
                }
            }
        }
        
        // Скрываем регулятор громкости на iOS и очень маленьких экранах
        document.addEventListener('DOMContentLoaded', () => {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const isSmallScreen = screenWidth < 360 || screenHeight < 500;
            const volumeBtn = document.querySelector('.mini-volume-btn');
            
            if (isIOS || isSmallScreen) {
                if (volumeBtn) {
                    volumeBtn.style.display = 'none';
                }
                // Добавляем класс для CSS правил
                if (isIOS) {
                    document.body.classList.add('ios-device');
                }
            }
        });
        
        // Обновляем счетчики лайков при смене трека
        const originalPlayTrack = window.playTrack;
        if (originalPlayTrack) {
            window.playTrack = function(index, autoPlay) {
                originalPlayTrack(index, autoPlay);
                // Обновляем счетчики лайков - используем данные из трека
                const tracksList = typeof window.tracks !== 'undefined' ? window.tracks : [];
                const currentIdx = typeof window.currentTrackIndex !== 'undefined' ? window.currentTrackIndex : (typeof currentIndex !== 'undefined' ? currentIndex : -1);
                if (currentIdx >= 0 && tracksList[currentIdx]) {
                    const track = tracksList[currentIdx];
                    window.currentTrackLikesCount = track.likes_count || 0;
                    // Используем реальный статус лайка из трека
                    window.currentTrackLiked = track.is_liked || false;
                    updateLikeButtons();
                }
            };
        }
        
        // Инициализация регулятора громкости в мини-плеере
        document.addEventListener('DOMContentLoaded', () => {
            const miniVolumeSlider = document.getElementById('mini-volume-slider');
            const audio = document.getElementById('audio-element');
            if (miniVolumeSlider && audio) {
                miniVolumeSlider.addEventListener('input', (e) => {
                    audio.volume = parseFloat(e.target.value);
                    const icon = document.getElementById('mini-volume-icon');
                    if (icon) {
                        if (e.target.value == 0) {
                            icon.name = 'volume-mute';
                        } else if (e.target.value < 0.5) {
                            icon.name = 'volume-low';
                        } else {
                            icon.name = 'volume-high';
                        }
                    }
                });
                
                // Синхронизация с основным регулятором громкости
                const mainVolumeSlider = document.getElementById('volume-slider');
                if (mainVolumeSlider) {
                    mainVolumeSlider.addEventListener('input', (e) => {
                        miniVolumeSlider.value = e.target.value;
                        audio.volume = parseFloat(e.target.value);
                    });
                }
            }
            
            // Обработчик кликов для лайков альбомов
            document.querySelectorAll('.album-like-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const albumId = btn.getAttribute('data-album-id');
                    if (albumId) {
                        toggleAlbumLike(parseInt(albumId));
                    }
                });
            });
            
            // Скрываем регулятор громкости при клике вне его
            document.addEventListener('click', (e) => {
                const container = document.getElementById('mini-volume-container');
                if (container && !container.contains(e.target) && !e.target.closest('.mini-volume-btn')) {
                    container.style.display = 'none';
                }
            });
        });

        // Храним оригинальные треки страницы отдельно от плеера
        window.pageTracks = {{ tracks|tojson|safe }};
        
        // Функция для воспроизведения трека из списка
        function playTrackFromList(index) {
            const idx = typeof index === 'string' ? parseInt(index) : index;
            console.log('playTrackFromList called with index:', idx, 'pageTracks length:', window.pageTracks ? window.pageTracks.length : 0);
            
            // Используем pageTracks - треки с ЭТОЙ страницы, а не из плеера
            if (!window.pageTracks || !Array.isArray(window.pageTracks) || window.pageTracks.length === 0) {
                console.error('Page tracks not loaded');
                return;
            }
            
            if (idx < 0 || idx >= window.pageTracks.length) {
                console.error('Invalid track index:', idx, 'pageTracks length:', window.pageTracks.length);
                return;
            }
            
            // ВАЖНО: Устанавливаем треки страницы в плеер ПЕРЕД воспроизведением
            window.tracks = window.pageTracks;
            
            if (typeof window.setTracks === 'function') {
                window.setTracks(window.pageTracks);
                console.log('Tracks synced to player:', window.pageTracks.length);
            }
            
            // Воспроизводим трек
            if (typeof window.playTrack === 'function') {
                console.log('Calling playTrack with index:', idx);
                window.playTrack(idx, true);
            } else {
                console.error('playTrack function not available');
                // Fallback - открываем страницу трека
                const track = window.pageTracks[idx];
                if (track) {
                    if (window.navigateToPage) {
                        window.navigateToPage('/track/' + (track.slug || track.id));
                    } else {
                        window.location.href = '/track/' + (track.slug || track.id);
                    }
                }
            }
        }

        // Предзагрузка данных для /app (если пользователь может быть авторизован)
        // Загружаем данные заранее чтобы при переходе на /app они были готовы
        const preloadAppData = async () => {
            try {
                // Проверяем авторизацию
                const profileRes = await fetch('/api/user/profile');
                if (profileRes.ok) {
                    const userData = await profileRes.json();
                    window.currentUser = userData;
                    console.log('User authenticated, preloading app data');
                    
                    // Предзагружаем треки и альбомы в фоне
                    Promise.all([
                        fetch(`/api/tracks?user_id=${userData.id}&show_hidden=true`).then(r => r.ok ? r.json() : []),
                        fetch(`/api/albums?user_id=${userData.id}`).then(r => r.ok ? r.json() : [])
                    ]).then(([tracks, albums]) => {
                        // Сохраняем в глобальные переменные для быстрого доступа
                        window.preloadedTracks = tracks;
                        window.preloadedAlbums = albums;
                        console.log('App data preloaded:', tracks.length, 'tracks,', albums.length, 'albums');
                    }).catch(e => {
                        console.log('Failed to preload app data:', e);
                    });
                }
            } catch (e) {
                // Игнорируем ошибки предзагрузки
                console.log('Preload skipped:', e);
            }
        };
        
        // Предзагружаем данные с небольшой задержкой
        setTimeout(preloadAppData, 1000);
        
        // Auth for saving user
        const isTelegram = window.Telegram && window.Telegram.WebApp;
        if (isTelegram) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            // Try to auth silently to capture user
            if (window.Telegram.WebApp.initData) {
                fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: window.Telegram.WebApp.initData})
                }).catch(e => console.log('Silent auth failed', e));
            }
        }
        
        // Инициализация плеера после загрузки
        document.addEventListener('DOMContentLoaded', () => {
            // Ждем загрузки player.js
            setTimeout(() => {
                if (typeof window.playTrack === 'function' && window.tracks && window.tracks.length > 0) {
                    console.log('Player initialized with', window.tracks.length, 'tracks');
                }
            }, 500);
        });
    </script>
    
    <!-- ФУТЕР -->
    <footer style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5); font-size: 14px; margin-top: 60px;">
        <p>swagplayer swag swag swag</p>
    </footer>
</body>
</html>