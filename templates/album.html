<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ album.title }} - SwagPlayer</title>
    <link rel="icon" type="image/x-icon" href="https://api.dreampartners.online/icons/swagaplayerobot/favicon.ico">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            padding-bottom: 200px; /* Место для плеера внизу */
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .album-header {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: center;
        }
        .album-cover {
            width: 300px;
            height: 300px;
            border-radius: 12px;
            object-fit: cover;
            background: #333;
            flex-shrink: 0;
        }
        .album-info {
            flex: 1;
        }
        .album-title {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 10px;
        }
        .album-artist {
            font-size: 20px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .album-artist img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .album-description {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            line-height: 1.6;
        }
        .tracks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .track-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #1c1c1e;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: inherit;
        }
        .track-item:hover {
            background: #2c2c2e;
        }
        .track-number {
            width: 30px;
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-weight: 600;
        }
        .track-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: #333;
        }
        .track-info {
            flex: 1;
        }
        .track-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .track-artist {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
        }
        
        /* Кнопка "Назад" */
        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            text-decoration: none;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-2px);
        }
        
        .back-btn:active {
            transform: translateX(-2px) scale(0.95);
        }
        
        @media (max-width: 768px) {
            .album-header {
                flex-direction: column;
                text-align: center;
            }
            .album-cover {
                width: 100%;
                max-width: 300px;
            }
            .album-title {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px;" id="back-btn-container">
            <!-- Кнопка назад показывается только если есть история (не прямой переход по ссылке) -->
            <button class="back-btn" id="back-btn" style="display: none;" onclick="window.SPANavigation?.goBack() || window.history.back()">
                <ion-icon name="arrow-back"></ion-icon>
            </button>
        </div>
        <script>
            // Показываем кнопку назад только если есть история навигации
            (function() {
                const backBtn = document.getElementById('back-btn');
                if (backBtn) {
                    // Проверяем, есть ли история (пришли не напрямую по ссылке)
                    const hasHistory = window.history.length > 1 || 
                                      (window.SPANavigation && window.SPANavigation.getHistoryLength && window.SPANavigation.getHistoryLength() > 1) ||
                                      document.referrer !== '';
                    
                    // Если referrer пустой и history.length <= 1 - это прямой переход
                    const isDirectLink = document.referrer === '' && window.history.length <= 1;
                    
                    if (!isDirectLink && hasHistory) {
                        backBtn.style.display = 'flex';
                    }
                }
            })();
        </script>
        <div class="album-header">
            {% if album.cover_filename %}
            <img src="/uploads/{{ album.cover_filename }}" alt="{{ album.title }}" class="album-cover">
            {% else %}
            <div style="width:300px; height:300px; border-radius:12px; background:linear-gradient(135deg, #333 0%, #1c1c1e 100%); display:flex; align-items:center; justify-content:center; font-size:120px;">
                <ion-icon name="albums"></ion-icon>
            </div>
            {% endif %}
            <div class="album-info">
                <h1 class="album-title">{{ album.title }}</h1>
                <div class="album-artist">
                    {% if album.avatar_url %}
                    <img src="{{ album.avatar_url }}" alt="{{ album.display_name }}">
                    {% endif %}
                    {% if album.nickname %}
                    <a href="/user/{{ album.nickname }}" style="text-decoration:none; color:inherit; cursor:pointer;">{{ album.display_name or album.nickname or 'Unknown' }}</a>
                    {% else %}
                    <span>{{ album.display_name or album.nickname or 'Unknown' }}</span>
                    {% endif %}
                </div>
                {% if album.description %}
                <div class="album-description">{{ album.description }}</div>
                {% endif %}
                <div class="album-stats" style="display: flex; gap: 20px; margin-top: 20px; align-items: center; justify-content: flex-start;">
                    <div style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: rgba(255,255,255,0.6);">
                        <ion-icon name="play" style="font-size: 16px;"></ion-icon>
                        <span class="album-plays-count">{{ album.plays_count or 0 }}</span>
                    </div>
                    <button class="album-like-btn {{ 'liked' if album.is_liked else '' }}" data-album-id="{{ album.id }}" onclick="toggleAlbumLike({{ album.id }})" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 14px;">
                        <ion-icon name="{{ 'heart' if album.is_liked else 'heart-outline' }}" class="album-like-icon"></ion-icon>
                        <span class="album-likes-count">{{ album.likes_count or 0 }}</span>
                    </button>
                </div>
                
                <style>
                    @media (max-width: 768px) {
                        .album-stats {
                            justify-content: center !important;
                        }
                    }
                </style>
            </div>
        </div>

        <div class="tracks-list">
            {% for track in tracks %}
            <div class="track-item" data-track-id="{{ track.id }}" data-tracks='{{ tracks|tojson|safe }}' onclick="playTrackFromAlbum({{ track.id }}, JSON.parse(this.dataset.tracks))" style="cursor:pointer;">
                <div class="track-number">{{ loop.index }}</div>
                {% if track.cover_filename %}
                <img src="/uploads/{{ track.cover_filename }}" alt="{{ track.title }}" class="track-cover"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                {% else %}
                <div style="width:60px; height:60px; border-radius:8px; background:#333; display:flex; align-items:center; justify-content:center;">
                    <ion-icon name="musical-notes" style="font-size:24px; color:#666;"></ion-icon>
                </div>
                {% endif %}
                <div style="display:none; width:60px; height:60px; border-radius:8px; background:#333; align-items:center; justify-content:center;">
                    <ion-icon name="musical-notes" style="font-size:24px; color:#666;"></ion-icon>
                </div>
                <div class="track-info">
                    <div class="track-title">{{ track.title }}</div>
                    <div class="track-artist">
                        {% if track.nickname %}
                        <a href="/user/{{ track.nickname }}" onclick="event.stopPropagation();" style="color: rgba(255,255,255,0.6); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#fa2d48'" onmouseout="this.style.color='rgba(255,255,255,0.6)'">{{ track.artist }}</a>
                        {% else %}
                        {{ track.artist }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Встроенный плеер -->
        <div id="album-player-container" style="position:fixed; bottom:0; left:0; right:0; background:#1c1c1e; border-top:1px solid rgba(255,255,255,0.1); padding:15px; z-index:2000; display:none;">
            <div id="album-player"></div>
        </div>
    </div>
    
    <!-- Аудио элемент для плеера -->
    <audio id="audio-element" playsinline preload="metadata" webkit-playsinline crossorigin="anonymous" style="display:none;"></audio>
    
    <!-- MINI PLAYER для альбома -->
    <div class="mini-player hidden" id="mini-player" onclick="expandPlayer()">
        <img src="" class="mini-cover" id="mini-cover">
        <div class="mini-info">
            <div class="mini-title" id="mini-title">Not Playing</div>
            <div class="mini-artist" id="mini-artist"></div>
        </div>
        <div class="mini-controls">
            <div onclick="event.stopPropagation(); prevTrack()">
                <ion-icon name="play-back"></ion-icon>
            </div>
            <div id="mini-play-btn" onclick="event.stopPropagation(); togglePlay()">
                <ion-icon name="play"></ion-icon>
            </div>
            <div onclick="event.stopPropagation(); nextTrack()">
                <ion-icon name="play-forward"></ion-icon>
            </div>
            <div class="mini-like-btn" id="mini-like-btn" onclick="event.stopPropagation(); toggleCurrentTrackLike()" title="Лайк">
                <ion-icon name="heart-outline" id="mini-like-icon"></ion-icon>
            </div>
            <div class="mini-volume-container" id="mini-volume-container" onclick="event.stopPropagation();" style="display: none;">
                <div class="mini-volume-slider-wrapper">
                    <input type="range" class="mini-volume-slider" id="mini-volume-slider" min="0" max="1" step="0.01" value="1" orient="vertical">
                </div>
            </div>
            <div class="mini-volume-btn" onclick="event.stopPropagation(); toggleMiniVolume()" title="Громкость">
                <ion-icon name="volume-high" id="mini-volume-icon"></ion-icon>
            </div>
            <div onclick="event.stopPropagation(); closeTrack()" class="mini-close-btn">
                <ion-icon name="close"></ion-icon>
            </div>
        </div>
    </div>
    
    <!-- FULL PLAYER для альбома -->
    <!-- МОДУЛЬНЫЙ ПЛЕЕР -->
    {% include 'player_component.html' %}
    
    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Определяем Telegram WebView перед загрузкой player.js
        window.isTelegram = window.Telegram && window.Telegram.WebApp;
        window.tgWebApp = window.isTelegram ? window.Telegram.WebApp : null;
        window.SHARED_MODE = false;
        
        // Определяем iOS и добавляем класс для скрытия громкости (после загрузки player.js)
        // isIOS будет определен в player.js
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof isIOS !== 'undefined' && isIOS) {
                    document.body.classList.add('ios-device');
                }
            }, 100);
        });
        
        // Функция для лайков альбома
        async function toggleAlbumLike(albumId) {
            try {
                const res = await fetch(`/api/albums/${albumId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (res.ok) {
                    const data = await res.json();
                    const btn = document.querySelector(`.album-like-btn[data-album-id="${albumId}"]`);
                    const countEl = btn ? btn.querySelector('.album-likes-count') : null;
                    const icon = btn ? btn.querySelector('.album-like-icon') : null;
                    if (btn && countEl) {
                        countEl.textContent = data.likes_count || 0;
                        if (data.liked) {
                            btn.style.background = 'rgba(250, 45, 72, 0.2)';
                            if (icon) {
                                icon.name = 'heart';
                                icon.setAttribute('fill', 'solid');
                            }
                        } else {
                            btn.style.background = 'rgba(255,255,255,0.1)';
                            if (icon) {
                                icon.name = 'heart-outline';
                                icon.removeAttribute('fill');
                            }
                        }
                    }
                } else if (res.status === 401) {
                    alert('Войдите в аккаунт для лайков');
                }
            } catch(e) {
                console.error('Error toggling album like:', e);
            }
        }
        
        window.toggleAlbumLike = toggleAlbumLike;
        
        // Функции для лайков треков в плеере
        window.currentTrackLiked = false;
        window.currentTrackLikesCount = 0;
        
        async function toggleCurrentTrackLike() {
            const tracksList = typeof window.tracks !== 'undefined' ? window.tracks : [];
            const currentIdx = typeof window.currentIndex !== 'undefined' ? window.currentIndex : (typeof window.currentTrackIndex !== 'undefined' ? window.currentTrackIndex : -1);
            if (currentIdx < 0 || !tracksList[currentIdx] || !tracksList[currentIdx].id) {
                console.warn('No track playing or no track ID');
                return;
            }
            
            const trackId = tracksList[currentIdx].id;
            try {
                const res = await fetch(`/api/tracks/${trackId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        window.currentTrackLiked = data.liked;
                        window.currentTrackLikesCount = data.likes_count || 0;
                        // Обновляем трек в массиве
                        if (tracksList[currentIdx]) {
                            tracksList[currentIdx].is_liked = data.liked;
                            tracksList[currentIdx].likes_count = data.likes_count;
                        }
                        if (typeof window.updateLikeButtons === 'function') {
                            window.updateLikeButtons();
                        }
                        if (typeof window.updateLikeUI === 'function') {
                            window.updateLikeUI();
                        }
                    }
                } else if (res.status === 401) {
                    alert('Войдите в аккаунт для лайков');
                }
            } catch(e) {
                console.error('Error toggling like:', e);
            }
        }
        
        async function toggleAlbumLike(albumId) {
            try {
                const res = await fetch(`/api/albums/${albumId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        const btn = document.querySelector(`.album-like-btn[data-album-id="${albumId}"]`);
                        const countEl = btn ? btn.querySelector('.album-likes-count') : null;
                        const icon = btn ? btn.querySelector('ion-icon') : null;
                        if (btn && countEl && icon) {
                            countEl.textContent = data.likes_count || 0;
                            if (data.liked) {
                                btn.classList.add('liked');
                                btn.style.color = '#fa2d48';
                                icon.name = 'heart';
                            } else {
                                btn.classList.remove('liked');
                                btn.style.color = 'white';
                                icon.name = 'heart-outline';
                            }
                        }
                    }
                } else if (res.status === 401) {
                    alert('Войдите в аккаунт для лайков');
                }
            } catch(e) {
                console.error('Error toggling album like:', e);
            }
        }
        
        window.toggleAlbumLike = toggleAlbumLike;
        
        function updateLikeButtons() {
            const playerLikeBtn = document.getElementById('player-like-btn');
            const playerLikeIcon = document.getElementById('player-like-icon');
            const playerLikesCount = document.getElementById('player-likes-count');
            
            if (playerLikeBtn && playerLikeIcon && playerLikesCount) {
                if (window.currentTrackLiked) {
                    playerLikeBtn.style.background = 'rgba(250, 45, 72, 0.2)';
                    playerLikeIcon.name = 'heart';
                    playerLikeIcon.setAttribute('fill', 'solid');
                } else {
                    playerLikeBtn.style.background = 'rgba(255,255,255,0.1)';
                    playerLikeIcon.name = 'heart-outline';
                    playerLikeIcon.removeAttribute('fill');
                }
                playerLikesCount.textContent = window.currentTrackLikesCount || 0;
            }
        }
        
        window.toggleCurrentTrackLike = toggleCurrentTrackLike;
        window.updateLikeButtons = updateLikeButtons;
        
        // Функция для переключения громкости в миниплеере
        function toggleMiniVolume() {
            const miniVolumeContainer = document.getElementById('mini-volume-container');
            if (miniVolumeContainer) {
                const isVisible = miniVolumeContainer.style.display === 'flex';
                miniVolumeContainer.style.display = isVisible ? 'none' : 'flex';
            }
        }
        window.toggleMiniVolume = toggleMiniVolume;
        
        // Инициализация регулятора громкости в мини-плеере
        document.addEventListener('DOMContentLoaded', () => {
            const miniVolumeSlider = document.getElementById('mini-volume-slider');
            const audio = document.getElementById('audio-element');
            if (miniVolumeSlider && audio) {
                miniVolumeSlider.addEventListener('input', (e) => {
                    if (audio) {
                        audio.volume = parseFloat(e.target.value);
                    }
                });
                
                // Синхронизируем значение при изменении громкости извне
                if (audio) {
                    audio.addEventListener('volumechange', () => {
                        if (miniVolumeSlider) {
                            miniVolumeSlider.value = audio.volume;
                        }
                    });
                }
            }
        });
        
        // Обновляем счетчики лайков при смене трека
        const originalPlayTrack = window.playTrack;
        if (originalPlayTrack) {
            window.playTrack = function(index, autoPlay) {
                originalPlayTrack(index, autoPlay);
                // Обновляем счетчики лайков
                const tracksList = typeof window.tracks !== 'undefined' ? window.tracks : [];
                if (index >= 0 && tracksList[index]) {
                    window.currentTrackLikesCount = tracksList[index].likes_count || 0;
                    window.currentTrackLiked = false; // TODO: проверять статус лайка пользователя
                    if (typeof window.updateLikeButtons === 'function') {
                        window.updateLikeButtons();
                    }
                }
            };
        }
        
        // Глобальные переменные для альбома - определяем ДО загрузки player.js
        window.albumTracks = {{ tracks|tojson|safe }};
        window.currentAlbumId = {{ album.id }};
        
        // Функция воспроизведения трека из альбома - определяем СРАЗУ глобально
        window.playTrackFromAlbum = function(trackId, tracksList) {
            // Если tracksList не передан или пуст, используем albumTracks
            if (!tracksList || !Array.isArray(tracksList) || tracksList.length === 0) {
                tracksList = window.albumTracks;
            }
            
            console.log('playTrackFromAlbum called:', trackId, 'tracks:', tracksList ? tracksList.length : 0);
            
            if (!tracksList || tracksList.length === 0) {
                console.error('No tracks available');
                return;
            }
            
            const index = tracksList.findIndex(t => t.id === trackId);
            if (index === -1) {
                console.error('Track not found in list:', trackId);
                return;
            }
            
            // Устанавливаем треки альбома в плеер
            window.tracks = tracksList;
            window.currentTrackIndex = index;
            window.currentIndex = index;
            
            if (typeof window.setTracks === 'function') {
                window.setTracks(tracksList);
            }
            
            // Воспроизводим
            if (typeof window.playTrack === 'function') {
                console.log('Calling playTrack with index:', index);
                window.playTrack(index, true);
                
                // Увеличиваем счетчик прослушиваний альбома
                if (window.currentAlbumId) {
                    fetch(`/api/albums/${window.currentAlbumId}/play`, { method: 'POST' }).catch(err => console.error('Error counting album play:', err));
                }
            } else {
                console.error('playTrack not available yet, retrying...');
                // Повторяем через 200мс когда player.js загрузится
                setTimeout(() => {
                    if (typeof window.playTrack === 'function') {
                        window.playTrack(index, true);
                        if (window.currentAlbumId) {
                            fetch(`/api/albums/${window.currentAlbumId}/play`, { method: 'POST' }).catch(err => {});
                        }
                    }
                }, 200);
            }
        };
        
        function closeAlbumPlayer() {
            const container = document.getElementById('album-player-container');
            if (container) container.style.display = 'none';
            const audio = document.getElementById('album-audio-player');
            if (audio) {
                audio.pause();
                audio.src = '';
            }
        }
        window.closeAlbumPlayer = closeAlbumPlayer;
    </script>
    <script src="/static/js/navigation.js?v=2"></script>
    <script src="/static/js/player.js?v=19"></script>
</body>
</html>


